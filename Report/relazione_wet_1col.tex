\documentclass[11 pt, a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[british]{babel}
\usepackage{indentfirst} 
\usepackage{graphicx}
\usepackage{tabularx}
\usepackage{siunitx}
\usepackage{amsmath,stix,bm}
%% fur amsmath, comment garamond and add
%% 'stix' btwn amsmath and bm
\usepackage{eucal}
%\usepackage{amsfonts}
%\usepackage{amssymb}
%\usepackage{wasysym}
%\usepackage{booktabs}
\usepackage{caption}
\usepackage{stfloats}

%\usepackage{lmodern}
\usepackage{multicol}
\usepackage[includeheadfoot,margin=0.4in,top=0.2in,bottom=0.35in]{geometry}
%%\usepackage{avant}
%Per grafica vettoriale tramite InkScape%
\usepackage{color}
\usepackage{transparent}
\graphicspath{{img/}}
\usepackage[dvipsnames]{xcolor}
\usepackage{pdfpages}
\usepackage{pgfplots}
\usepackage{textcomp}
\usepackage{tgbonum}
\usepackage{xcolor,colortbl}
%\usepackage{simpsons}
%\usepackage{addfont}
%\addfont[1.5]{OT1}{simfon}{\simfon}
\usepackage{listings}
\usepackage{rotating}

\usepackage{cleveref}
\usepackage{caption}
\DeclareCaptionFont{quack}{}
\captionsetup[figure]{font={color=gray,scriptsize},labelfont={color=black,sc}}
\captionsetup[table]{font={color=gray,scriptsize},labelfont={color=black,sc}}
\captionsetup[subfigure]{font={color=gray,scriptsize},labelfont={color=black}}
\usepackage{subcaption}
\usepackage{titlesec}
\titleformat*{\section}{\LARGE\bfseries\color{orange_work}}
\titleformat*{\subsection}{\large\bfseries\color{orange_work}}
\titleformat*{\subsubsection}{\itshape\bfseries\color{orange_work}}

	\definecolor{burntsienna}{rgb}{0.91, 0.45, 0.32}
	\definecolor{carrotorange}{rgb}{0.93, 0.57, 0.13}
	\definecolor{darktangerine}{rgb}{1.0, 0.66, 0.07}
	\definecolor{deepsaffron}{rgb}{1.0, 0.6, 0.2}
	\definecolor{flax}{rgb}{0.93, 0.86, 0.51}
	\definecolor{lava}{rgb}{0.81, 0.06, 0.13}
	
\usepackage{pifont}% http://ctan.org/pkg/pifont
\newcommand{\cmark}{\ding{51}}%
\newcommand{\xmark}{\ding{55}}%
%\color{Turquoise}
%\color{Turquoise}
%\color{Turquoise} 

\definecolor{mintbg}{rgb}{.63,.79,.95}
%% 
%\graphicspath{{figures/}} %Setting the graphicspat%h
%\graphicspath{{figures/}} %Setting the graphicspath
\graphicspath{{figures/}{figures/A/}{figures/B/}{figures/C/}{figures/C/new_fields/}} %Setting the graphicspath
\makeatletter
%\providecommand*{\input@path}{}
%\edef\input@path{{figures/}{}\input@path}% prepend
\def\input@path{{figures/}{figures/A/}{figures/B/}{figures/C/}{figures/C/new_fields/}}
\makeatother
\usepackage{import}
\usepackage{adjustbox}

\pgfplotsset{compat=newest}
\pgfplotsset{plot coordinates/math parser=false}
\newlength\figureheight
\newlength\figurewidth
\usepackage{placeins}
\usepackage{float}
\usepackage{blindtext}
\usepackage{authblk}
\renewcommand\Affilfont{\tiny \color{gray}}

\title{\color{orange_work}\LARGE\textbf{Development and Analysis of an Array of Folded Patch Antennas Using Matlab}}
%\author{Blasi Luca\thanks{The first author wants to thank someone.}	, Mastrofini Alessandro, Mucenica Stefan Leonard}
\author[]{Blasi Luca}
\author[2]{Mastrofini Alessandro}
\author[3]{Mucenica Stefan Leonard}
\affil[2]{\small alessandro.mastrofini@alumni.uniroma2.eu}
\affil[3]{\small stefanleonard.mucenica@alumni.uniroma2.eu}

\date{}
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
	\lhead{\small\color{gray} University of Rome Tor Vergata}
\fancyfoot[R]{\footnotesize{\thepage\  of \pageref{LastPage}}}
\renewcommand{\headrulewidth}{0.50pt}

%\lhead{Guides and tutorials}
\fancypagestyle{plain}{
	\renewcommand{\headrulewidth}{0.5pt}
	%\setlength{\headheight}{80 pt} 
	\lhead{\small\color{gray} Wireless Electromagnetic Technologies \\
		Professor: Marrocco Gaetano\\
	University of Rome Tor Vergata\\2022}
	\rhead{\includegraphics[height=60pt]{logo.png} }
	\fancyfoot{}
}
\usepackage{lastpage}
\addtocontents{toc}{\protect\setcounter{tocdepth}{0}}

\usepackage{lipsum}
\usepackage[
backend=bibtex,
style=numeric
]{biblatex} %Imports biblatex package
\addbibresource{mybib.bib} %Import the bibliography file
\usepackage{titlesec}
\titlespacing{\section}{0pt}{\parskip}{-\parskip}
\titlespacing{\subsection}{0pt}{\parskip}{-\parskip}
\titlespacing{\subsubsection}{0pt}{\parskip}{-\parskip}
\usepackage{listings}
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codestring}{rgb}{0.623, 0.176, 0.588}
\definecolor{backcolour}{rgb}{0.96,0.96,0.96}
\definecolor{bbcolour}{rgb}{0.01,0.03,0.35}
\definecolor{indexcolour}{rgb}{0,0.4,0.4}
\definecolor{myOrange}{rgb}{0.933, 0.313, 0.066}
\definecolor{myBlue}{rgb}{0, 0.298, 0.8}
\lstdefinestyle{mystyle}{
	backgroundcolor=\color{backcolour},   
	commentstyle=\color{codegreen},
	classoffset=1,
	keywordstyle=\color{bbcolour},
	numberstyle=\tiny\color{codegray},
	stringstyle=\color{codestring},
	basicstyle=\ttfamily\small,
	breakatwhitespace=false,  
	breaklines=true,                 
	captionpos=b,                    
	keepspaces=false,                 
	numbers=left,                    
	numbersep=3pt,                  
	showspaces=false,                
	showstringspaces=false,
	showtabs=false,                  
	tabsize=2
}
\lstset{texcl=false, mathescape=true,style=mystyle}
\lstset{emph={%  
		i, j,X,n,Y,polarpattern,subfigure,pattern%
	},emphstyle={\color{bbcolour}}%
}%

\definecolor{orange_work}{rgb}{0.827, 0.411, 0.011}
\usepackage{tikz}
\usetikzlibrary{fit}
\usetikzlibrary{shapes.geometric, arrows}
\tikzstyle{startstop} = [rectangle, rounded corners, minimum width=7cm, minimum height=1cm,text centered,  fill=backcolour,text width=6.5 cm,draw=gray]
\tikzstyle{startstop2} = [rectangle, rounded corners, minimum width=5cm, minimum height=2cm,text centered,  fill=backcolour,draw=gray]
\tikzstyle{io} = [trapezium, trapezium left angle=80, trapezium right angle=100, minimum width=7cm, minimum height=1cm, text centered,text width=6.5 cm,  fill=backcolour,draw=gray]
\tikzstyle{io2} = [trapezium, trapezium left angle=70, trapezium right angle=110, minimum width=2cm, minimum height=1cm, text centered,  fill=backcolour,draw=gray]
\tikzstyle{process} = [rectangle, minimum width=7cm, minimum height=1cm, text centered,text width=6.5cm,  fill=backcolour,text badly centered,draw=gray]
\tikzstyle{decision} = [diamond, minimum width=1cm, minimum height=1cm, text centered,  fill=backcolour,draw=gray,text width=2cm]
\tikzstyle{arrow} = [thick,->,>=stealth]
\tikzstyle{process2} = [rectangle, minimum width=3.5cm, text width=3.2cm,minimum height=1cm, text centered, dashed, fill=backcolour,draw=gray]
\tikzstyle{process3} = [rectangle, minimum width=4cm,text width=4cm, minimum height=1cm, text centered,  fill=backcolour,draw=gray]
\tikzstyle{process4} = [rectangle, minimum width=6cm,text width=5.5cm, minimum height=1cm, text centered,  fill=backcolour,draw=gray]
\usepackage[graphicx]{realboxes}
\AtBeginBibliography{\footnotesize}
% redefinition of \texttt
%\let\Oldtexttt\texttt
%\renewcommand\texttt[1]{{\ttfamily\color{ttcolor}#1}}
\begin{document}
{\fontfamily{ptm}\fontsize{11}{11}\selectfont
	\let\center\flushleft
	\maketitle
	\let\endcenter\endflushleft
\begin{center}
	\begin{abstract}
	\fontsize{10}{10}\selectfont{
		The latest developments in Computer Aided Engineering, by means of the remarkable progress that several softwares have been made in terms of computational speed and of enlarged ranges of phaenomena that can be simulated and accurately analyzed, represent an immense span to inventiveness. For this particular instance, it is also a great opportunity for who wants to reach or already has an expertise in the Antenna Design field. In this article, among a vast amount of possibilities, some of the \texttt{Matlab} toolboxes dedicated to antenna designing have been adopted in such a way as to create the structure of a coaxial-fed folded patch antenna combined with a low performance dielectric substrate (i.e. $\operatorname{FR4}$). The main purpose was to obtain an antenna resonating at $2.1\,$GHz and with an input impedance matched at $50\,$Ohms. Subsequently, this designed radiating object has been introduced in a broader structure, that is a linear array of five antennas, as its representative single element. The Tchebyshev array synthesis has been used in order to reach particular design and radiating behaviour. Specifically, the beam-steering in the broadside and at $45^\circ$ off the boresight direction have been analyzed by means of the overall gain and the electric and magnetic field behaviour close and far from the array. All the mathematical models which have been used together with the software feedback represent the structure of an overall process of development, optimization and analysis which have been very carefully performed and shown in the following paragraphs.}
	%The design of an antenna through Computer Aided Engineering allows to optimize the parameters in such a way as to have the best desired behavior. In this case, an array of five antennas for 2.1 GHz is designed using \texttt{Matlab} and the \texttt{Antenna Design Toolbox}. 
	%The design followed all the important steps, starting with the design of the array factor and the folded patch. The folded patch also requires some properties to be optimized in order to obtain the best behavior and the matching at 50 Ohms. 
	%This is followed by several tests on the overall behavior of the five folded patch array. The phase coefficients were also calculated to have the beamsteering in both directions and 45 ° out of the pointing direction. 
	%All the parameters to physically create the array are shown in the report together with some considerations on the simulation of folded patches with \texttt{Matlab}.
\end{abstract}
\end{center}
\section*{Introduction}
All the parameters necessary to generate the array structure are shown in this paper together with some considerations on the implications of running certain simulations and of the deriving results. The array of folded patch antennas has been designed entirely in \texttt{Matlab}. Some flaws in the tools that have been used emerged in terms of lacking of full compatibility between them and some limitations in creating and analyzing the exact structure intended for this design. For example, the single folded patch antenna couldn't be used as an array element in the \texttt{Antenna Toolbox} (which would have allowed studying the overall array behaviour in terms of gain and electromagnetic fields), while the \texttt{Phased Sensor Array Analyzer} made possible creating the array structure but it couldn't give results describing the electromagnetic field. This puzzling situation made it necessary to reach a compromise by using a similar structure to that of the folded patch antenna: a PCB stack shorting the patch with a series of small cylindrical pins instead of using a rectangular wall of metal as in the original design recommendation. Some results could be obtained both with the original structure and with its approximation: in those cases several comparations shown their radiating behaviour is very similar, thus the approximation represents an acceptable compromise. 

Starting from the theoretical modeling based on mathematical formulations \textbf{\cite{Balanis1}}, a set of parameters related to the single antenna (the reflection coefficient, the size of the patch and the ground, the substrate thickness, the feed location) have been optimized based upon a mesh density refinement process. 

Generally, the study of an antenna array starts with the design of the array factor. The array factor is the complex-valued far field radiation pattern obtained by considering the elements to be punctiform sources. The total field is both influenced by the angular filtering effect of the array factor (which disregards the particular structure of the array element, but taking into account informations as spatial arrangement and currents circulating on the array alements) and the single element radiation. This gives an idea of how the behavior of the single antenna is affected by the other antennas of the array. All the elements are participating to those mutual interactions, bringing out a different behaviour in all. 

Subsequently, several tests were conducted in order to verify that the the overall behavior of the array complies with the project requirements. A flowchart of all the steps of the project is available at page \pageref{fig:flowchart_2}.

	
\section*{Tchebyshev array factor design}

 A Tchebyshev array factor will be designed in this part, so that the specific structure of the single element of the array is disregarded for the moment. The array is represented by a linear distribution of five elements ($n_{el}=5$), which are supposed to be uniformly spaced and with a non-uniform amplitude for the feed arrangement, that anyway is going to be symmetrical (starting from the element in the middle, located in the origin of the geometrical axes). Also the "\emph{mean lobe to side lobe ratio}" ($R$) will be one of the input design variables. Thus, the variables of this design part are the \emph{element inter-spacing} ($d_{opt}$, which needs to be optimal such that the beamwidth is minimized), the feed amplitude of the single antenna (each one represented by a $C_i$, with $i\in\{-2,-1,0,1,2\}$, the $i^{th}$ \emph{current coefficient} - these unknowns are actually just three and not five, due to the symmetrical amplitude distribution hyphotesis), the operating \emph{resonant frequency} required for the single antenna ($f$) and some other quantities related to them, such as the \emph{tapering efficiency} ($\eta_T$) and the \emph{beamwidth} ($BW_{\operatorname{fn}}$). Moreover, the difference between the beamwidth of the Tchebyshev array (\emph{Uniform Spacing Non Uniform Amplitude} case, shorten $NUA$) and  that of a uniform array having the same number of elements and inter-spacing value but a uniform amplitude feed distribution  (\emph{Uniform Spacing Uniform Amplitude}, shorten $UA$) will be discussed. The input design variables related to the Tchebyshev array factor (i.e. $n_{el}$, $R$ and $f$) are listed in \textbf{\cref{table:input_design_cheb}}. 

Starting from the optimal inter-element spacing, it requires some secondary variables in orderer to be evaluated. Firstly, a coefficient ($\gamma$, depending on $R$ and indirectly on the number of array elements) neeeds to be calculated, among with the wavelength in the free space ($\lambda$, as the ratio between the light speed in the free space - $c$ - and the operating frequency $f$). Having those quantities, $d_{opt}$ minimizing the $BW_{\operatorname{fn}}$ can be computed by using the \textbf{\cref{eq:test}} group. 

\begin{table}[b!]	\small{
	\begin{minipage}{0.48\linewidth}

	\begin{center}
		{
			\fontfamily{ptm}\selectfont	\begin{tabular}{|m{4cm}|m{4cm}|}
				\hline
				\cellcolor{deepsaffron}\textbf{Parameter} & \cellcolor{deepsaffron}\textbf{Value}\\
				\hline
				\# elements & $n_{el}=2N+1=5$\\
				\hline
				Main lobe/side lobe
				ratio  & $R = 120 \cong\, 41.58\,dB$\\
				\hline 
				Frequency & $f\,=\,2.1\,GHz$\\
				\hline
		\end{tabular}}
		\caption{Array factor input design variables}
		\label{table:input_design_cheb}
	\end{center}
\end{minipage}
	\begin{minipage}{0.48\linewidth}
	\begin{center}
		{\fontfamily{ptm}\selectfont
			\begin{tabular}{|m{4cm}|m{4cm}|}
				\hline
				\cellcolor{deepsaffron}\textbf{Parameter}
				& \cellcolor{deepsaffron}\textbf{Value} 
				\\
				\hline
				{Feed coefficients} $[A]$ &  \footnotesize{$\begin{aligned}
						&C_0 = 	41.2						\\
						&C_1=C_{-1} = 29.8 \\
						&C_{2}=C_{-2} = 9.6 \\
					\end{aligned}$}\\
				\hline 
				{Feed coefficients 
					
					normalized to $C_{\max}$} &  
				\footnotesize{$\begin{aligned}
						&C_0^* = 	1.000						\\
						& C_1^*=C_{-1}^* = 0.7215 \\
						& C_{2}^*=C_{-2}^*  =0.2336 \\
					\end{aligned}$} \\
				\hline
				{Tapering efficiency} & \footnotesize{$\eta_T\,=\,79\,\%$}\\ 
				\hline 
				\textbf{Beamwidth} & $ \begin{matrix}
					\text{Tchebyshev} & &50.6^\circ \\
					
					\text{Uniform} &  & 34.8^\circ\\
				\end{matrix} $ \\
				\hline 
		\end{tabular}}
		\caption{Tchebyshev array design results}
		\label{table:tcheby results}
	\end{center}
\end{minipage}}
\end{table}


The array factor evaluation through the Tchebyshev polynomial comes as the next step. The Tchebyshev polynomial approximation to the second order ($T_2(x)$) is sufficient so the current coefficients can be obtained, remembering that a symmetrical amplitude distribution hypothesis has been made. In this case the current coefficients $C_i\,,\,i\in\{-2,-1,0,1,2\}$ follow the rule $C_i=C_{-i}$, thus their symbolic representation can be simplified as follows: $C_n\,,\,n\in\{0,1,2\}$ (or just $n\,=\,\overline{0,2}$). Since the \emph{Riblet variation} to the \emph{Dolph-Tchebyshev synthesis model} has been used, the variable of $T_2(x)$ becomes $x\,=\,a\,+\,b\cos(u)$ and the formulation for $d_{opt}\,\in\,({\lambda}/{2},\lambda]$ differs from the standard model. The coefficients $a$ and $b$ are related to the maximum value selected in the sub-domain of $T_2(x)$ (the window of visible radiation lobes). This maximum, called for example $x_1$, corresponds to the main lobe in which it can be convertend by evaluating the array factor $|T_2(x_1)|$ (some additional references to the specific formulas that need to be used in order to compute can be found in \textbf{\cite{Balanis1}} and \textbf{\cite{ewa}}). That said, the current coefficients can be extracted from $T_2(x)$ (so by using \textbf{\cref{eq:tcheby poly coeff}}). Resulting uniquely out of a $C_n$ dependence, the tapering efficiency is obtained by using \textbf{\cref{eq:tapering efficiency}}.
\begin{multicols}{2}


{\begin{equation}
		\begin{gathered}
			d_{opt}\,{\leadsto}\,\min\{BW_{\operatorname{fn}}\}\\
			\\
			d_{opt}\,{=}\,\lambda\,\left[1\,-\,\frac{\arccos\left(\frac{1}{\gamma}\right)}{\pi}\right]\\
			\\
			\gamma\,{=}\,\cosh\left[\frac{1}{2N}\,\ln\left(R+\sqrt{R^2-1}\right)\right]
		\end{gathered}
		\label{eq:test}
	\end{equation}
}
\begin{equation}\begin{split}
		\begin{aligned}
			T_2\left[x=a+b\cos\,u\right]=\dots\\
			=\,C_0\,+\,2\,C_1\,\cos\,u\,+\,C_2\cos\,2u\\
			=\,(2a^2+b^2-1)\,+\,4ab\,\cos\,u+b^2\,\cos\,2u
			\label{eq:tcheby poly coeff}
		\end{aligned}
	\end{split}
\end{equation}

\begin{equation}
	\eta_T\,=\,\frac{1}{2N+1}\,\frac{||C_0+2C_1+2_2||^2}{C_0^2+2C_1^2+2C_2^2}
	\label{eq:tapering efficiency}
\end{equation}

\begin{equation}
	\begin{gathered}
		BW_{\operatorname{fn}}^{[UA]}\,{<}\,BW_{\operatorname{fn}}^{[NUA]}\\
		\\
		BW_{\operatorname{fn}}^{[NUA]}\,{=}\,2\frac{180}{\pi}\left[\frac{\pi}{2}-\arccos\left(\frac{\arccos\left(\frac{\cos\left(\frac{\pi}{2N}-a\right)}{b}\right)}{k_0d}\right)\right]\\
		\\
		BW_{\operatorname{fn}}^{[UA]}\,{=}\,\frac{2\lambda}{N\,d}\,\frac{180}{\pi}
	\end{gathered}
	\label{eq:tcheby beamwidth}
\end{equation}
\end{multicols}
 

Next, both non uniform amplitude (Tchebyshev array, $NUA$) and uniform amplitude ($UA$)  cases are compared. The comparison shows how the $BW_{\operatorname{fn}}$ in the $UA$ case (i.e $BW_{\operatorname{fn}}^{[UA]}$) is narrower than that of the $NUA$ case (i.e. $BW_{\operatorname{fn}}^{[NUA]}$). This result (see \textbf{\cref{eq:tcheby beamwidth}} and \textbf{\cref{table:tcheby results}}) is generally effective and the comparison has been made to show that this particular design case confirms the general condition. 



 

All the numerical results related to the Tchebyshev array design are gathered together in \textbf{\cref{table:tcheby results}}. After these quantities are calculated, some important design considerations can be made about the array efficiency. A Non-Uniform Amplitude Array Factor has been designed by using the Riblet variation of the Dolph-Tchebyshev array synthesis model. Considering the \emph{maximum to minimum feed ratio}: \[r_{\max/\min}\,=\,\frac{C_{\max}}{C_{\min}}\] 
the less $r_{\max/\min}$ is, the more efficient distribution of current is reached. In this particular design, the requirement was to to find the $d_{opt}$ which minimizes the beamwidth, starting from the input design variables. Thus, the $r_{\max/\min}$ is a straight consequence of the current coefficients and its optimal value has not been the seek of this project. Anyway, for this design, $r_{\max/\min}\,\cong\,4.39$ meaning that if a damage of the element with the $C_{\max}$ (i.e. $C_0$) level of feed occurs, most part of the efficiency will be lost. In any case, the tapering efficiency shows how it will not be possible to take advantage of $21\,\%$ of the array in an ideal situation, remembering that this design model can be discerned by the real circumstance in terms of the Tchebyshev error (see \textbf{\cite{Balanis1}}). 



\begin{figure*}[bt!]
\centering
	\begin{subfigure}[t]{0.35\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{pcb_array_factor_with_toolbox_polar_az_tex.pdf_tex}}
		\caption{}
		%\includegraphics[scale=0.3]{array_factor_polar.png}
	\end{subfigure}
\hspace{0.05\linewidth}
	\begin{subfigure}[t]{0.45\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{pcb_array_factor_with_toolbox_rectangular_az_tex.pdf_tex}}
		\caption{}
	\end{subfigure}

	\begin{subfigure}[t]{0.35\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{pcb_array_factor_with_toolbox_polar_el_tex.pdf_tex}}
		\caption{}
		%\includegraphics[scale=0.3]{array_factor_polar.png}
	\end{subfigure}\hspace{0.05\linewidth}
	\begin{subfigure}[t]{0.45\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{pcb_array_factor_with_toolbox_rectangular_el_tex.pdf_tex}}
		\caption{}
	\end{subfigure}

	\caption{{Array factor polar, in azimuth (a) and elevation (c) cut, and rectangular  in azimuth (b) and elevation (d) cut, diagrams}}
	\label{fig:array factor}
\end{figure*}




In the end, the 2D array patterns resulting by the use of the calculated parameters are shown in \textbf{\cref{fig:array factor}}. Two polar patterns and their corresponding rectangular ones have been plotted (in the azimuth cut plane and in the elevation cut one). 

		% \FloatBarrier



%%% POINT B %%%

\section*{Rectangular folded patch 	
	antenna design}

The main components of a rectangular folded patch are: the patch, the substrate (generally accessory, but used in this project), the ground, the rectangular shorting wall between the patch and the ground, and the feed. More details about them will be presented in a short while. Before that, some other remarks are necessary: this antenna will be the element of the array, which will be designed starting actually from a PIFA (\emph{Planar Inverted F Antenna}).
%because of the limitations of the \texttt{Antenna Toolbox} (the way those limitations have been overcome is discussed in detail in \textbf{\color{BurntOrange} Methods}). 
A general PIFA realized with a dielectric substrate is shown in \textbf{\cref{fig:patch_structure}}. A particular condition is imposed to the PIFA, by which the width of the rectangular shorting wall ($w_{sc}$) equals the patch width ($W_{\operatorname{patch}}$), so that the PIFA and the folded patch antenna will be two equivalent structures (see \textbf{\cref{eq:shorting condition}}). This remark on the PIFA is necessary because generally its structure is not equivalent to that of the folded patch antenna because of the possible variability of the shorting width ($w_{sc}$), which doesn't always satisfy the above imposed condition. This condition on $w_{sc}$ represents one of the input variables of the PIFA design, such as the matched input resistance ($R_{in}$), the resonant frequency ($f$) and the substrate characteristics (see \textbf{\cref{table:pifa design parameters}}). A preliminary evaluation of the patch parameters have been realized by leaning on a theoretical set of formulas (see \textbf{\cite{Balanis1}}). That's the reason why the characteristics of the PIFA, shown in \textbf{\cref{table:pifa design parameters}}, are distinguished between pre-optimal and post-optimal (same thing applies to the ground component). Thus, an optimization process of all these and other parameters will be performed in some following steps. Just before that, now the theoretical model will be shortly pointed out: it furnishes a provisional set of results (that will be adjusted afterward) . Firstly, the length and the width of the patch starting from the $w_{sc}=W_{\operatorname{patch}}$ imposed condition, the substrate wavelength and thickness (i.e. $\lambda_{\operatorname{FR4}}$ and $h_{\operatorname{FR4}}$) are calculated (\textbf{\cref{eq:patch size}}). Then, other parameters, such as the effective permittivity $\varepsilon_{eff}$  and length ($L_{eff}$) in \textbf{\cref{eq:patch effective}}, the radiation resistance ($R_r$) in \textbf{\cref{eq:radiation resistance}}, the half-power beamwidth in the E-cut ($\Theta_E$) and the H-cut ($\Theta_H$) in \textbf{\cref{eq:beamwidth EH cuts}} and eventually the feed location, defined by $\ell_{\operatorname{feed}}$ in the patch length direction with respect to the free edge (\textbf{\cref{eq:feed length coordinate}}), have been calculated. 
\section*{Refinement with MatLab Method of Moments}
\subsection*{Substrate thickness selection}Three thickness levels were available for the $FR4$ substrate required in this project (see \textbf{\cref{table:pifa design parameters}}). In this part it will be explained why choosing a thinner substrate (if the $FR4$ is used) is more convienient. This choice will be motivated both in relation to the physical behaviour (radiation efficiency) and to the limits of the \texttt{Matlab} tools that have been used (in terms of the mesh density level selection in a range that gives more reliable results). 

\begin{figure*}[bt!]
	\begin{subfigure}{0.3\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{patch_structure_tex.pdf_tex}}
	\end{subfigure}
	\hfill
	\begin{subfigure}{0.3\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{patch_structure_2_tex.pdf_tex}}
	\end{subfigure}
	\hfill
	\begin{subfigure}{0.3\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{patch_structure_3_tex.pdf_tex}}
	\end{subfigure}
	%\includegraphics[scale=0.35]{patch_structure.pdf}
	%\includegraphics[scale=0.35]{patch_structure_2.pdf}
	%\includegraphics[scale=0.35]{patch_structure_3.pdf}
	
	\caption{PIFA realized with a dielectric substrate}
	\label{fig:patch_structure}
\end{figure*}




\begin{table}[t!]	\small{
	\begin{minipage}{0.48\linewidth}
		\begin{center}	
		% \FloatBarrier
		{\fontfamily{ptm}\selectfont
			\begin{tabular}{|m{4cm}|m{4cm}|}
				\hline 
				\rowcolor{deepsaffron}\multicolumn{2}{|c|}{\textbf{Folded patch design parameters}} 
				\\
				\hline
			
				\cellcolor{flax} Substrate & \cellcolor{flax} FR4 \\
				\hline
				Relative permittivity & $\varepsilon_{\operatorname{FR4}}\,=\,4.8$ \\
				
				Relative permeability & $\mu_{\operatorname{FR4}}\,\cong\,1$\\
				
				Loss tangent & $\{\tan(\delta)\}_{\operatorname{FR4}}\,=\,0.0260$\\
				\hline 
				
			Available thicknesses &\\ 
				(1) & $h_{\operatorname{FR4}}\,=\,0.8\,mm$ 
				
				(optimal choice)\\
				(2) & $h_{\operatorname{FR4}}\,=\,1.0\,mm$ \\
				(3) & $h_{\operatorname{FR4}}\,=\,1.6\,mm$ \\
				\hline
				\cellcolor{flax} Patch
				  & \cellcolor{flax} Copper \\
				\hline
				%\begin{subtable}{0.25\textwidth}
				%	\begin{tabular}{|c|c|}
					%		\hline
					%		try & c\\
					%		\hline
					%	\end{tabular}
				%	
				%	\end{subtable} & \\
			%\hline
			Conductivity & $\kappa_{\operatorname{copper}}\,=\,5.96^.10^7\,S/m$ \\
			
			Thickness & $h_{\operatorname{patch}}\,=\,3.556\,^.\,10^{-5}\,m$\\
			\hline 
			Length & \\
			(pre-opt) & $L_{\operatorname{patch}}\,\cong\,\frac{\lambda_{\operatorname{FR4}}}{4}\,=\,0.0171\,m$\\
			(post-opt) & $L_{\operatorname{patch}}=0.0158\,m$\\
			\hline
			Width & \\
			(pre-opt) & $W_{\operatorname{patch}}\,\cong\,0.0419\,m$\\
			(post-opt) & $W_{\operatorname{patch}}\,\cong\,0.0358\,m$\\
		\hline
			
			Half-power beamwidth 
			
			(pre-optimization) & 
		$\Theta_E=360^\circ$ (E-cut) \\
		& $\Theta_H=121^\circ$ (H-cut)\\
		Half-power beamwidth
	
	(after optimization) & $\Theta_E=109^\circ$ (E-cut)\\
	& $\Theta_H=325^\circ$ (H-cut)\\
			\hline
	\end{tabular}}

\end{center}
\end{minipage}
\begin{minipage}{0.49\linewidth}
		\begin{center}	
		% \FloatBarrier
		{\fontfamily{ptm}\selectfont
			\begin{tabular}{|m{4cm}|m{4cm}|}
				\hline 
				\rowcolor{deepsaffron}\multicolumn{2}{|c|}{\textbf{Folded patch design parameters}} 
				\\
				\hline
					Frequency & $2.1\,GHz$ \\
				\hline
				Matched input resistance & $R_{in}\,=\,50\,\Omega$\\
				\hline
			\cellcolor{flax}Ground 
			
			(pre-optimized features)
			& \cellcolor{flax} Copper
			
			(same conductivity listed above) \\
			\hline
			Thickness & $h_{GND}\,=\,h_{\operatorname{patch}}$
			\\
			\hline
			Length & \\ 
			(pre-opt) & $L_{GND}\,=\,0.04\,m$\\
			(post-opt) & $L_{GND}\,=\,0.0296\,m$\\
			\hline 
			Width &  	\\
			(pre-opt) & $W_{GND}\,=\,0.06\,m$\\
			(post-opt) & $W_{GND}\,=\,0.0580\,m$ \\
			\hline
			\cellcolor{flax}Feed & \cellcolor{flax} Coaxial cable \\
			\hline
			Position across $L_{\operatorname{patch}}$ &\\
			(pre-opt) & $0.0066\,m$ \\
			(post-opt) & $0.0067\,m$ \\
			\hline
			Position across $W_{\operatorname{patch}}$ & \\
			(pre-opt) & $0.0000\,m$\\
			(post-opt) & $0.0010\,m$\\
			\hline
	\end{tabular}}
\end{center}
\end{minipage}
	\caption{Project input parameters (frequency, matching and substrate features), theoretical (pre-optimized, shorted "pre-opt") and optimized ("post-opt") features of the patch and ground PIFA components}
\label{table:pifa design parameters}}
\end{table}



\begin{multicols}{2}
	\begin{equation}
		W_{\operatorname{patch}}\,=\,w_{sc}
		\label{eq:shorting condition}
	\end{equation}
\begin{equation}
	\begin{aligned}L_{\operatorname{patch}}\,+\,W_{\operatorname{patch}}\,-\,w_{sc}\,&{=}\,\frac{\lambda_{\operatorname{FR4}}}{4}\,+\,h_{\operatorname{FR4}}\\
		W_{\operatorname{patch}}\,&{=}\,\frac{\lambda}{2}\,\sqrt{\frac{2}{\varepsilon_{\operatorname{FR4}}\,+\,1}}\\
	\end{aligned}
	\label{eq:patch size}
\end{equation}
\begin{equation}
	\begin{aligned}
		\varepsilon_{eff}\,{=}\,\frac{\varepsilon_{\operatorname{FR4}}+1}{2}\,+\,\frac{\varepsilon_{\operatorname{FR4}}-1}{2}\,\left(1+12\frac{h_{\operatorname{FR4}}}{W_{\operatorname{patch}}}\right)^{-\frac{1}{2}}\\
		L_{eff}\,{=}\,\frac{\lambda_{\operatorname{FR4}}}{4}\\
		\Delta L{=}0.412\,h\,\left[\frac{(\varepsilon_{eff}+0.3)\,\left(\frac{W_{\operatorname{patch}}}{h_{\operatorname{FR4}}}+0.268\right)}{(\varepsilon_{eff}-0.258)\,\left(\frac{W_{\operatorname{patch}}}{h_{\operatorname{FR4}}}+0.8\right)}\right]\\
		L\,=\,L_{eff}-2\Delta L
	\end{aligned}
	\label{eq:patch effective}
\end{equation}
\begin{equation}
	R_r\,{=}\,\frac{120\,\lambda}{W_{\operatorname{patch}}}\,\left[1-\frac{1}{24}\,\left(2\pi\,\frac{h_{\operatorname{FR4}}}{\lambda}\right)^{2}\right]^{-1}\\
	\label{eq:radiation resistance}
\end{equation}
\begin{equation}
	\begin{aligned}
		\Theta_E\,&{=}\,2\,\arccos\,\sqrt{\frac{7.03\,\lambda^2}{4\,(3\,L_e^2+h_{\operatorname{FR4}}^2)\,\pi^2}}\\
		\Theta_H\,&{=}\,2\,\arccos\sqrt{\frac{1}{2\,+\,2\pi\,\frac{W_{\operatorname{patch}}}{\lambda}}}\\
	\end{aligned}
	\label{eq:beamwidth EH cuts}
\end{equation}
\begin{equation}
	\ell_{\operatorname{feed}}\,{=}\,\frac{L_{\operatorname{patch}}}{\pi}\,\arccos\,\sqrt{\frac{R_{in}}{R_r}}
	\label{eq:feed length coordinate}
\end{equation}
\end{multicols}


	%\begin{table}[bt!]
	%\begin{center}
	%	%%% \FloatBarrier
	%	{
	%5		\begin{tabular}{||m{2.5 cm}|m{2.5 cm}|m{2.5 cm}||}
	%			\hline 
	%			\rowcolor{lightgray}\multicolumn{3}{|c|}{\textbf{FR4 substrate project thickness available} (mm)} 
	%			\\
	%			\hline
	%			\cellcolor{flax}$h_{\operatorname{FR4}}^{(1)}=0.8$ & 
	%			\cellcolor{flax}$h_{\operatorname{FR4}}^{(2)}=1.0$ & 
	%			\cellcolor{flax}$h_{\operatorname{FR4}}^{(3)}=1.6$ \\
	%			\hline
				
	%	\end{tabular}}
	%	\caption{Three levels of $FR4$ substrate thickness are shown above. In the antenna industry, the $FR4$ substrate thickness generally ranges from $0.8\,mm$ and $3.6\,mm$}
	%	\label{table:substrate tchickness}\end{center}\end{table}
%\begin{equation}\begin{aligned}
%		h_{\operatorname{FR4}} &= 0.8\,mm\,\leadsto\,h_{\lambda}\,=\,\frac{1}{81}\\	h_{\operatorname{FR4}} &= 1.0\,mm\,\leadsto\,h_{\lambda}\,=\,\frac{1}{62}\\
%	\end{aligned}
%	\label{eq:substrate relative thickness}
%\end{equation}

The \texttt{Antenna Toolbox} gives specific
information about the mesh density level that should be adopted for the design of the patch antenna components. The only issue is that these details are given only for particular ranges of the ratio indicator called \emph{relative thickness} or \emph{electrical thickness} $h_{\lambda}$ (see \textbf{\cite{makarov}} and \textbf{\cite{meshing}}). The electrical thickness depends on the ratio between the substrate thickness ($h_{\operatorname{FR4}}$) and the wavelength related to the substrate medium ($\lambda_{\operatorname{FR4}}$). When a mesh is configured in the \texttt{Antenna Toolbox} environment, a specific parameter needs to be adjusted: the maximum edge length of the generic triangle covering the geometry of the antenna ($e_{\max}$). In the case of a relative length $h_\lambda$ comparable to $1/10$, it's recommended to select an $e_{\max}\,\cong\,\lambda/10$. A substrate thickness respecting this relationship is called a \emph{thick substrate}. None of the available substrates verifies this condition. Among them, only the thinnest substrate and the second to last one (thus $h_{\operatorname{FR4}}=0.8\,mm$ and $h_{\operatorname{FR4}}=1.0\,mm$) are part of a range which the \texttt{Antenna Toolbox} provides instructions of. It's the \emph{thin substrate range}: the automatic mesh mode should be adopted for a thin substrate, namely having a relative thickness less or equal than one fiftieth ($h_\lambda\,\leq{1/50}$). This leads to a further explanation about the actual substrate thickness chosen for this project. The thinner substrate choice rationale starts with the consideration of its quality factor ($Q$) depending on the loss tangent ($tan\delta$) and being generally low in the FR4 substrate case (being the two quantities inversely proportional, i.e. $Q\,\propto\,1/tan\delta$, and being $(\tan\delta)$ very high compared to that of other more efficient substrates). This means the FR4 is a big power dispersor. Since increasing $h_{\operatorname{FR4}}$ will provoke just more losses in terms of a radiation efficiency drop and since the only thickness values of $0.8\,mm$ and $1.0\,mm$ would give reliable/accurate results in the \texttt{Antenna Toolbox} simulations, the $0.8\,mm$ thickness level will be adopted. 
\subsection*{Mesh density refinement}
Although a mesh density choice has already been made by selecting the best maximum edge length $e_{\max}$, the accuracy achievable by using the mesh automatic mode in the case of substrates belonging to the  \emph{thin substrate range} will be proved hereafter. An initial study of the mesh density level influence on the reflection coefficient ($\Gamma$ in $dB$) evaluated at the resonant frequency ($f=2.1\,GHz$) has been realized, thus a  $\Gamma_{2.1\,GHz}=F(e_{\max})$ function has been plotted with an initial step of $\Delta e_{\max} = 2.5^.10^{-4}\,m$ between every two mesh densities related to their specific $e_{\max}$. This first simulation considered a broader range of $e_{\max}$ variation: $[2.5^.10^{-4}\,m\,,\,6.0^.10^{-4}\,m]$. 
 

Since the resulting plot  (\textbf{\cref{fig:first mesh test}}) has shown big uncertainty of the reflection coefficient value at the resonant frequency ($\Gamma_{2.1\,GHz}$) at almost every mesh $e_{\max}$ level (primarily due to the big step selected between one density level and another), some more detailed tests have been run, by considering a slightly narrower range ($[2.5^.10^{-4}\,m\,,\,5.0^{-4}\,m]$) and a tchicker evaluation of the maximum edge values (so that the mesh variation step has been remarkably reduced to $1.0^.10^{-4}\,m$). Specifically, the step between two mesh density levels in terms of the maximum edge length of each one has been reduced from a $\Delta e_m=2.5^.10^{-4}$ to $\Delta e_m=1.0^.10^{-4}$. In all those simulations, an important fact needs to be noted. Even very small variations on the maximum edge length value involved considerable inconsistencies in almost every part of the mesh range in terms of considerable variations of the frequency at wich $\Gamma$ reaches its minimum ($\min(\Gamma)$, therefore the resonant frequency of the antenna changes very easily).  
Thus, considering the frequency $f^*$ at which $\min(\Gamma)$ is actually obtained, instead of evaluationg it at the theoretical resonating frequency value at every mesh level, not only the standard test comparing $e_{\max}$ and $\Gamma$ has been run, but also some mesh refinement plots representing the relationship between $f^*$ and $e_{\max}$ (\textbf{\cref{eq:f vs mesh}}), $\Delta f^*$ and $e_{\max}$ (\textbf{\cref{eq:Df vs mesh}}) and also $\min(\Gamma)$ and $e_{\max}$ (\textbf{\cref{eq:minG vs mesh}}) have been taken into account (where $\Delta f^*$ is the difference between $f^*$ and the resonant frequency $f=2.1\,GHz$). More parameter relationships have been collected and this led to the setting of the mesh density choice in terms of $e_{\max}$ that has been selected inside the most stable region (i.e. showing the smallest deviation of the reflection coefficient minimum from the resonant frequency). In the end it's been specifically taken the 'automatic' $e_{\max}$ ($=3.5^{-4}\,m$) suggested by the \texttt{Antenna Toolbox}, since this value  belongs to the stable region and seems to give the most accurate results. The $e_{\max}$ values belonging to the stable region ($[3.1\,^.\,10^{-4}\,m,3.7^.10^{-4}\,m]$) exibit slight deviations from the resonant frequency ($\Delta f^*\,\in\,[0.01\,GHz,0.03\,GHz]$) and the minimum of the reflection coefficient varies in the range $[-24\,dB\,,\,-33\,dB]$. 


\begin{figure*}[t!]
	\centering
	\begin{subfigure}[b]{0.4\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{gamma_pre_wfeed_tex.pdf_tex}}
		%\includegraphics[scale=0.25]{First_Contour_LOG.pdf}
		\caption{}
	\end{subfigure}
\hspace{0.05\linewidth}
	\begin{subfigure}[b]{0.42\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{impedence_pre_wfeed_tex.pdf_tex}}
		%\includegraphics[scale=0.25]{Second_Contour_LOG.pdf}
		\caption{}
	\end{subfigure}
	\caption{Reflection coefficient (a) and impedance (b) plots depending on $f\,\in\,[2.0,2.1\,GHz]$}
	\label{fig:Gamma and Z previa wfeed}
\end{figure*}



\begin{figure*}[bt!]
	\begin{subfigure}{0.48\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{First_Contour_LOG_tex.pdf_tex}}
		%\includegraphics[scale=0.25]{First_Contour_LOG.pdf}
		\caption{}
		\label{fig:first contour}
	\end{subfigure}
	\hfill
	\begin{subfigure}{0.48\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{Second_Contour_LOG_2_tex.pdf_tex}}
		%\includegraphics[scale=0.25]{Second_Contour_LOG.pdf}
		\caption{}
		\label{fig:second contour}
	\end{subfigure}
	\caption{First (a) and second (b) contour plots depending on the patch size ($L_{\operatorname{patch}}$ and $W_{\operatorname{patch}}$ variations)}
\end{figure*}


\begin{figure*}[bt!]
		\begin{subfigure}{0.4\linewidth}
				\def\svgwidth{\linewidth}
			\tiny{\input{gamma_wfeed_tex.pdf_tex}}
					\caption{}
		\end{subfigure}
	\hfill
		\begin{subfigure}{0.42\linewidth}
				\def\svgwidth{\linewidth}
			\tiny{\input{matching_wfeed_tex.pdf_tex}}
					\caption{}
		\end{subfigure}
		\caption{Final $\Gamma$ (a) and impedance matching (b) plots after further refinement including $w_{\operatorname{feed}}$ change}
		\label{fig:Gamma and Z}

		\begin{subfigure}[b]{0.28\linewidth}
				\def\svgwidth{\linewidth}
			\tiny{\input{gain_azimuth_pifa_tex.pdf_tex}}
			\caption{}	\end{subfigure}
		\hfill
		\begin{subfigure}[b]{0.28\linewidth}
					\def\svgwidth{\linewidth}
			\tiny{\input{gain_elevation_pifa_tex.pdf_tex}}
			\caption{}	\end{subfigure}
		\hfill
		\begin{subfigure}[b]{0.34\linewidth}
					\def\svgwidth{\linewidth}
			\tiny{\input{pifa_currents_tex.pdf_tex}}
			\caption{} \end{subfigure}
		\hfill
		\caption{Gain patterns (a) in the nulle elevation plane, (b) in the null azimuth plane and (c) 3D current plot on the patch antenna }
\end{figure*}



\subsection*{Patch parameters refinement}
\begin{figure*}[bt!]
	
	\begin{subfigure}[t]{0.32\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{minGamma_vs_mesh_level_tex.pdf_tex}}
		%\includegraphics[scale=0.3]{minGamma_vs_mesh_level.pdf}
		\caption{}
		\label{eq:minG vs mesh}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{0.32\linewidth}
		%\includegraphics[scale=0.3]{DeltaF_vs_mesh_level.pdf}
		\def\svgwidth{\linewidth}
		\tiny{\input{DeltaF_vs_mesh_level_tex.pdf_tex}}
		
		\caption{}
		\label{eq:Df vs mesh}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{0.32\linewidth}
		%\includegraphics[scale=0.3]{F_vs_mesh_level.pdf}
		\def\svgwidth{\linewidth}
		\tiny{\input{F_vs_mesh_level_tex.pdf_tex}}
		
		\caption{}
		\label{eq:f vs mesh}
	\end{subfigure}
	\hfill
	\caption{Comparison of the meshing parameter $e_{\max}$ with minimum of reflection coefficient (a), variation of the resonant frequency with respect to the design one (the dotted line represents the value with respect to automatic meshing) (b), resonant frequency identified by the minimum of $\Gamma$ (c)} 
\end{figure*}
After the selection of the maximum edge length of the mesh (consequently, of its density level), a more refined computation of the reflection coefficient will be made, depending on the patch size (i.e. on its length and width), but also on the feed location. Firstly, only a parametric variation of the feed position across the patch length direction has been considered, depending on variations of $L_{\operatorname{patch}}$ and $W_{\operatorname{patch}}$. This means that the first refinement of the feed position has been evaluated starting from its theoretical equation (depending indirectly by $W_{\operatorname{patch}}$). The change of the feed location has been taken into account in the computation of every step of the simulation, thus in every evaluation of the reflection coefficient, keeping $e_{\max}$ as a constant (the previously selected length). The patch size variations provoked wide modifications of the reflection coefficient, which values depending on that have been represented by an initial contour plot (with variations of the patch size in a broader range and with a larger step between one value and another, see \textbf{\cref{fig:first contour}}). After that, another simulation (\textbf{\cref{fig:second contour}}) in a narrower range of the patch size variation has been run in order to choose from there a set of $\Gamma$ values (related to a set of coupled values $(L_{\operatorname{patch}},W_{\operatorname{patch}})$) that should put the patch antenna in the best resonant condition (which means that a $\Gamma$ as close as possible to zero in the linear scale and as negative as possible in the $dB$, logarithmic scale is sought). The logarithmic ($dB$ scale) was used for the contour plots because this way the resulting $\Gamma$ values are easier to distinguish from one another even grafically and mathematically. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% se c'è tempo e spazio ancora nella relazione %%%%%%%%%
%% discutere anche sul VSWR %%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% che dev'essere il più vicino ad 1 %%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
A set of 20 values of $\Gamma$ and respective coupled values ($L_{\operatorname{patch}},W_{\operatorname{patch}}$). has been selected from the second simulation range so that a more specific simulation could be run. In this third case (\textbf{\cref{fig:Gamma couple LpWp}}), the reflection coefficient has been plotted in a range around the resonant frequency ($[2.0\,GHz, 2.2\,GHz]$) in order to find which is the best combination for the patch size that makes actually resonate the antenna at the project frequency. Another determining and discriminating factor was the input impedance ($Z_{in}=R_{in}+\jmath Y_{in}$, where the real part of $Z_{in}$ is the input resistance, while the imaginary one is the input reactance), because a impedance matching (at $50\,\Omega$) needed to be achieved for the project. In the ideal case, of course, a reflection coefficient $\Gamma^{(id)}=0.00\,\to\,-\infty\,dB$ would be required in order to reach the perfect impedance matching (perfect matching with input resistance at $50.00\,\Omega$ and null reactance). As an actual result, before seeking a better matching, the $\Gamma$ value related to all the couple candidates ($(L_{\operatorname{patch}},W_{\operatorname{patch}})$) ranged from $-24\,dB$ to $-30\,dB$. The two best candidates of the $\Gamma$ value related to the coupled size ($L_{\operatorname{patch}},W_{\operatorname{patch}}$) are plotted in \textbf{\cref{fig:Gamma couple LpWp}}. Two refined plots (with narrower frequency steps in the same range) of $\Gamma$ and $Z$ for one of the candidates are represented in \textbf{\cref{fig:Gamma and Z previa wfeed}}. An additional design strategy contributed to the final patch size choice: the feed location varying across the patch width direction ($w_{\operatorname{feed}}$). Thus, a parametric impedance matching study depending on that has been run on the best couple candidates and a few others from the set of 20. The resulting values are listed in \textbf{\cref{table:Gamma and Z}} and the plots are shown in \textbf{\cref{fig:Gamma and Z}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\begin{center}
%	\fbox{\begin{minipage}{0.7\linewidth}
%\textbf{\color{Mahogany}\emph{Thinner substrate choice} rationale}. The quality factor depending on $tan\delta$ is generally low in the FR4 substrate case. This means the FR4 is a big power dispersor. Since increasing $h_{\operatorname{FR4}}$ will provoke just more losses in terms of a radiation efficiency drop and since the only thickness values of $0.8\,mm$ and $1.0\,mm$ would give reliable/accurate results in the \texttt{\color{Mahogany}Antenna Toolbox} simulations, the $0.8\,mm$ will be adopted.
%	\end{minipage}}
%\end{center}
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%

%%% le seguenti 3 figure le faremo più grandi una volta che sapremo dove effettivamente saranno posizionate nella relazione finale %%% 
%% w_{\operatorname{feed}} = 0.001 


	\subsection*{From the PIFA to a PCB stack approximation}
	
	
	
Since the \texttt{Antenna Array Designer (AAD)} is not able to generate an array of PIFAs , the \texttt{Sensor Array Analyzer (SAA)} has been used to create that type of structure, starting from the Tchebyshev array factor design made in the first part and from the previous optimization process of a single PIFA. In the last part the overall array of PIFAs needs to be analyzed by means of beamsteering for particular angles, total gain, electric and magnetic field patterns. Unfortunately, not all of this information can be extracted by using uniquely the the \texttt{SAA} tool. This fact led to the use of another tool, the \texttt{PCB Antenna Designer}, so that all the parameters required for the project could be analyzed. With this last tool, a similar structure to that of the PIFA has been realized and introduced as the antenna element of the array distribution. Just before moving to the array analysis, a comparison between the single antenna being a PIFA structure and the antenna created by using a PCB stack was performed. A single limitation in the use of the \texttt{PCB Antenna Designer} has been encountered, but it has been overcome with an approximation strategy. Thus, the PIFA and the PCB stack designed are not perfectly identical, but their single and overall performance inside the array had shown a slight quantifiable difference. The limitation consisted in the absence of a specific option or combination of commands that would allow to realize the rectangular shorting wall between the patch and the ground. The only thing the designer can do is to replace this kind of shorting pin with a series of small diameter (e.g. $0.4\,mm$) cylindrical shorting pins (see \textbf{\cref{fig:pcb shorting}}) and \textbf{\cref{fig:pcb shorting zoom}} close to one edge of the patch, across the patch width direction. With this design choice, a very similar behaviour to that of the PIFA structure was possible to simulate. To support this results, a comparison of the 2D gain patterns (elevation and azymuth cut) of the PIFA to those of the PCB stack antenna has been realized in terms of the mean squared error values, shorten $MSE$, related to the two specific two-dimensional patterns considered ($MSE_{el}=0.55dB$ in the elevation cut directivity pattern and $MSE_{az}=0.16dB$ in the azimuth cut directivity pattern). Furthermore, since the \texttt{SAA} allows the plotting of some patterns such as the directivity (but not of the gain), a comparison between the 2D patterns of the antenna array of PIFAs and the array of PCBs has been presented. In that case the error is presented as a comparison between the main lobe levels in the PIFA array and the PCB array cases, but also in terms of first first side lobe levels of the two arrays (see \textbf{\cref{table:array comparison error}}). This discussion was necessary, because moving to the last part of the project required a deeper study of the array of antennas, that will be displayed by using the PCB antenna as the element of the array. A further discussion about the differences between the tools can be consulted in the \textbf{ Methods}. 

\begin{figure}[bt!]
\centering
		%	\includegraphics[scale=0.3]{mesh_first_test.pdf}
		\begin{minipage}{0.4\linewidth}
			\def\svgwidth{\linewidth}
			\tiny{\input{mesh_first_test_tex.pdf_tex}}
			\hfill
			\caption{{Minimum of the reflection coefficient $\Gamma\, [dB]$ in the frequency range $2.0\div 2.2\,GHz$ depending on the varying mesh density level}}
			\label{fig:first mesh test}
		\end{minipage}\hspace{0.1\linewidth}
		\begin{minipage}{0.4\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{pcb_structure_zoom_tex.pdf_tex}}
	\caption{Cropped zoom over PCB via holes. For an overall picture see \cref{fig:pcb shorting}}
	\label{fig:pcb shorting zoom}
			\end{minipage}
\end{figure}






\section*{Overall array performance}
In this last part of the project, the array factor and the the element antenna (PIFA or PCB stack) designs will be combined so that their total effect will be examined. As it's been already mentioned in the previous paragraph, some of the information describing the overall array performance can be asked from both the \texttt{SAA} (where the array of PIFAs was designed) and the \texttt{PCB/AAD} (where the single patch antenna made starting from the PCB stack and also the whole array can be constructed). The performance of the overall array will be evaluated in two cases: in the broadside case ($90^\circ$) but also at $45^\circ$ off the boresight direction. First of all, it is very simple to identify the phase shift coefficients in the broadside case because they all equal $0^\circ$ (there's no actual phase shift between antennas). In the second case, some manual calculation can be made in order to insert the phase shifts between the single antennas (this is the case of the PCB stack array), and it can be also automatically computed by using the array of PIFAs. The generic procedure is shown in \textbf{\cref{eq:phase coefficients}}. Just before moving to the last part of the analysis, where only the characteristics of the array of PCBs will be considered, a last comparison between the array of PCBs and the array of PIFAs will be made in terms of 2D directivity patterns (both in broadside and in $45^\circ$ off the boreside direction, see \textbf{\cref{fig:pcb pifa array comparison}}). An error analysis based on the difference between the PCBs array main lobe and that of the PIFAs array, but also on the difference between the PCBs array main side lobe and that of the PIFAs array will be shown (see \textbf{\cref{table:array comparison error}}). The patterns and the numerical results according to the numerical error values illustrate how the array of PCBs represent a good enough approximation of the array of PIFAs (see \textbf{\cref{fig:array gain}} and \textbf{\cref{fig:pcb pifa array comparison}}). 

\begin{table*}[bt!]
	\small{
	\begin{center}
		{\fontfamily{ptm}\selectfont	\begin{tabular}{|m{3cm}|m{3.4cm}|m{3.4cm}|m{3.4cm}|m{3.4cm}|}
				\hline
				\rowcolor{deepsaffron}\textbf{Direction} & \textbf{$D_{ML,az}$ error} & \textbf{$D_{SL,az}$} & \textbf{$D_{ML,el}$ error} & \textbf{$D_{SL,el}$} \\
				\hline 
				Broadside ($90^\circ$) &
				
						$\begin{aligned}
							\Delta D_{ML}&=	2.39\,dB\\
							\Delta D_{ML}^r &=3.3\,\%
						\end{aligned}$ 
					
			 & 
				
						$\begin{aligned}\Delta D_{SL}&=0.96\,dB \\
						\Delta D_{SL}^r&=2.7\,\%\end{aligned}$ 

				 & $\begin{aligned}
						\Delta D_{ML}&=0.81\,dB\\
						\Delta D_{ML}^r&=1.1\,\%
					\end{aligned}$
				 & $\begin{aligned}
				 	\Delta D_{SL}&=0.35\,dB\\
				 	\Delta D_{SL}^r&=1.6\,\%	\end{aligned}$
			 \\
				\hline
				
				%%%%%%%%%%%%%%%%%%%%%%%%%%%%55
				%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
				%%%%%%%%%%%%%%%%%%%%%%%%%%%%
			
				\hline 
				Off Boresight ($45^\circ$) & 	
				$\begin{aligned}
					\Delta D_{ML}&=0.05\,dB\\
					\Delta D_{ML}^r&=0.07\,\%	
				\end{aligned}$
			& 	$\begin{aligned}
				\Delta D_{SL}&=1.37\,dB\\
				\Delta D_{SL}^r&=3.4\,\%\end{aligned}$
			& $\begin{aligned}
				\Delta D_{ML}&=0.03\,dB\\
			\Delta D_{ML}^r&=0.04\,\%\end{aligned}$	 
		& $\begin{aligned}
			\Delta D_{SL}&4.1\,dB\\
	\end{aligned}$	  \\
				\hline
		\end{tabular}}
		\caption{Comparison between the array of PIFAs and the array of PCBs in terms of the directivity evaluated in their main lobes and first side lobes, both in the broadside and $45^\circ$ off the boresight direction, both in the azimuth cut ($az$) and elevation cut ($el$) planes. The comparison has been made in terms of the directivity difference ($\Delta D_{\#}=D_{PIFAs}-D_{PCBs}$ in $dB$) in the corresponding positions and also as a relative percentage error ($\Delta D^r_{\#}$\%, the ratio between $\Delta D_{\#}$ and the directivity in the array of PIFAs case ($D_{PIFAs}$)}
		\label{table:array comparison error}
	\end{center}}
\end{table*}
\begin{table*}[bt!]	\small{
	\begin{center}
			\small{\fontfamily{ptm}\selectfont\begin{tabular}{|m{4cm}|m{2.6cm}|m{2cm}|m{2cm}|m{2.3cm}|m{2.3cm}|}
		
				\hline
				\rowcolor{deepsaffron} $fre\leadsto\text{Fresnel limit}$ 
							
				$fraun\leadsto\text{Fraunhofer limit}$
			
				& Position & $E$-field ($90^\circ$) & $H$-field ($90^\circ$) & $E$-field ($45^\circ$) & $45$-field ($90^\circ$) \\
				\hline 
				%%%%%%%%%%%%%%%%%%%%%
				%%%%%% || 1 || %%%%%%
				%%%%%%%%%%%%%%%%%%%%%
				$PCB$ fed by $C_{-2}$ & $(0,-2d_{opt},z_{fre}/2)$ & $0.1027$ & $0.0139$ & $0.2071$ & $0.0269$ \\ 
				 &  $(0,-2d_{opt},z_{fraun}/2)$ & $0.0848$ & $0.0114$ &$0.2071$	 & $0.0269$ \\
				 & $(0,-2d_{opt},4z_{fraun})$& $0.0161$& $0.0020$ &$0.1651^.10^{-3}$ & $0.1360^.10^{-3}$ \\
				\hline
				%%%%%%%%%%%%%%%%%%%%%
				%%%%%% || 2 || %%%%%%
				%%%%%%%%%%%%%%%%%%%%%
				 $PCB$ fed by $C_{-1}$ & $(0,-d_{opt})$ & $0.2923$ & $0.0377$ & $0.1889$ & $0.0100$ \\
				 &$(0,-d_{opt},z_{fraun}/2)$ &$0.1144$ & $0.0143$&$0.1889$ & $0.0100$\\
					 & $(0,-d_{opt},4z_{fraun})$& $0.163$& $0.0020$& $0.1493^.10^{-3}$& $0.1365^.10^{-3}$\\
				\hline
				%%%%%%%%%%%%%%%%%%%%%
				%%%%%% || 3 || %%%%%%
				%%%%%%%%%%%%%%%%%%%%%
				Main $PCB$, fed by $C_{0}$ & $(0,0,z_{fre}/2)$& $0.4189$& $0.0522$& $0.2422$ & $0.0174$ \\
			 & $(0,0,z_{fraun}/2)$& $0.1258$& $0.0155$& $0.2492$& $0.0174$\\
				 & $(0,0,4z_{fraun})$ & $0.163$& $0.0020$& $0.1285^.10^{-3}$& $0.1364^.10^{-3}$\\
				\hline 
				%%%%%%%%%%%%%%%%%%%%%
				%%%%%% || 4 || %%%%%%
				%%%%%%%%%%%%%%%%%%%%%
				 $PCB$ fed by $C_{1}$ & $(0,d_{opt},z_{fre}/2)$ & $0.3306$ & $0.0367$ & $0.2619$ & $0.0215$ \\
				 & $(0,d_{opt},z_{fraun}/2)$& 0.1191& 0.0145&0.2619& 0.0215\\
					 & $(0,d_{opt},4z_{fraun})$& $0.162$& $0.0020$& $0.1053^.10^{-3}$& $0.1357^.10^{-3}$\\
				\hline 
				%%%%%%%%%%%%%%%%%%%%%
				%%%%%% || 5 || %%%%%%
				%%%%%%%%%%%%%%%%%%%%%
				 $PCB$ fed by $C_{2}$& $(0,2d_{opt},z_{fre}/2)$ & $0.1350$ & $0.0143$ & $0.2922$ & $0.0270$ \\
				 & $(0,2d_{opt},z_{fraun}/2)$&$0.0971$ & $0.0116$&$0.2922$ & $0.0270$\\ 
					 & $(0,2d_{opt},4z_{fraun})$& $0.162$ & $0.0020$ & $0.0744^.10^{-3}$&$0.1343^.10^{-3}$ \\
				\hline
		\end{tabular}}
		\caption{Particular electric ($E$) and magnetic ($H$) field values measured in both broadside ($90^\circ$) and in the $45^\circ$ off the boresight directions. The $E$-field is measured in $\left[\frac{V}{m}\right]$ while the $H$-field in $\left[\frac{A}{m}\right]$. The fields have been measured with respect to the centers of each element antenna vertically off the array plane at different height levels of $z_{fre}$ (inductive region), $z_{fraun}$ (radiative region) and $4^.z_{fraun}$ (particular coordinate in the far field region).}  
		\label{table:EH fields}
	\end{center}}
\end{table*} 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% creare una tabella  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% in cui inserire i corretti dati di confronto %%%%%%%%
%%% inseriti in una tabella dopo che comincia %%%%%%%%%%%
%%% "Overall patch antenna array performante" %%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\subsection*{Total array gain}

\begin{figure*}[bt!]

	\begin{subfigure}{0.24\linewidth}
		\def\svgwidth{\linewidth}
		\fontsize{4}{4}\selectfont{\input{pcb_array_azimuth_gain_real_vs_ideal.pdf_tex}}
		\caption{}
	\end{subfigure}	\hfill
	\begin{subfigure}{0.24\linewidth}
		\def\svgwidth{\linewidth}
	\fontsize{4}{4}\selectfont{\input{pcb_array_elevation_gain_real_vs_ideal.pdf_tex}}
		\caption{}
	\end{subfigure}	\hfill
	\begin{subfigure}{0.24\linewidth}
		\def\svgwidth{\linewidth}
	\fontsize{4}{4}\selectfont{\input{pcb_array_elevation_45_gain_real_vs_ideal.pdf_tex}}
		\caption{}
	\end{subfigure}
	\hfill
	\begin{subfigure}{0.24\linewidth}
		\def\svgwidth{\linewidth}
	\fontsize{4}{4}\selectfont{\input{pcb_array_azimuth_45_gain_real_vs_ideal.pdf_tex}}
		\caption{}
	\end{subfigure}\hfill
	\caption{2D gain patterns (ideal \textcolor{myOrange}{$\blacksquare$} and real \textcolor{myBlue}{$\blacksquare$} ) in both the broadside case ((a) azimuth cut and (b) elevation cut) and $45^\circ$ off the boresight direction ((c) azimuth cut and (d) elevation cut).}
	\label{fig:array gain}
\end{figure*}


In order to obtain and describe the last plots of the project, it is not possible to recur to the \texttt{SAA} because some of the commands, such as  and \texttt{EHfields()} and \texttt{patternMultiply()}, are not available in this tool. Thus, in this last part, only the array of PCBs will be used, because it's compatible with these commands. The total array gain will be computed and displayed in two different cases: by means of a fullwave model (with no approximation) and by using the pattern multiplication principle. This second case is idealistic because it makes an approximation of the real patterns by not considering the mutual induced interactions between the single antennas of the array; however, a "mathematical" interaction is considered in this model because it comes out of a formulation that mixes the single element effect (which gives an element gain factor $G_0$) on the gain pattern with the angular filtering influence of the array factor, weighted by a combination of the current coefficients (which gives an array gain factor $G_F$). The overall idealistic case is based on the pattern multiplication principle, which (in a case such as the Tchebyshev array synthesis model, thus with non uniform amplitude feed), will take into account also the effect of the tapering efficiency ($\eta_T$) in its formulation (see \textbf{\cref{eq:pattern multiplication}}). Thus, the pattern multiplication principle can be applied angle by angle and this will provide a set of values that can be computed and inserted in matrices by using \texttt{MatLab}. Starting from the matrices, the 2D patterns can be represented. On the other hand, an easier way is to use the \texttt{patternMultiply()} command and get the ideal patterns. 


\subsection*{Electric and magnetic near fields}

\begin{figure*}[bt!]
	\centering
	\begin{subfigure}{0.38\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{EHfield_prfe_broadside.pdf_tex}}
		\caption{}
	\end{subfigure}	\hspace{0.15\linewidth}
	\begin{subfigure}{0.38\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{EHfield_prfe_45.pdf_tex}}
		\caption{}
	\end{subfigure}	
	\begin{subfigure}[b]{0.4\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{EHfield_prfe_broadside_center.pdf_tex}}
		\caption{}
	\end{subfigure}
	\begin{subfigure}[t]{0.13\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{EH_legend.pdf_tex}}
	\end{subfigure}	
	\begin{subfigure}[b]{0.4\linewidth}
		\def\svgwidth{\linewidth}
		\tiny{\input{EHfield_pfre_45_center.pdf_tex}}
		\caption{}
	\end{subfigure}
	\caption{Electric and magnetic fields in Fresnel region in both broadside (a) and 45° off the boresight direction (b). Same fields calculated in the center of the position of the antennas in both broadside (c) and 45° off the boresight direction (d). The contribution of the various coefficients is evident.}
	\label{fig:EH field}
\end{figure*}


The near field characteristics (distinguishing between its inductive and radiative regions) have been analyzed in both the broadside and by beamsteering to $45^\circ$ off the boresight conditions. Two situations have been analyzed: the general near field behaviour (in its electric and magnetic field components) but also the specific orientation of the fields in the center position of each of the five elements composing the antenna (so, considering the $x$ and $y$ coordinates of each patch corresponding to the length and width directions of its planar development and the $z$ coordinate representing the vertical component of the distance between the observation point and the array). The vertical distance $z$ has been considered in three different cases. First, the Fresnel region (inductive near field region) has been analyzed at {\small$z_{fre}=0.62\sqrt{L_{\max}^3/\lambda}$ (where $L_{\max}$} is the maximum size of the array, thus $L_{\max}=4d_{opt}+L_{\operatorname{patch}}$), while the radiative near field region was measured, starting from the Fraunhofer limit expression ($z_{fraun}=2D^2/\lambda$), at $z_{fraun}/2$. Moreover, it's been considered an observation point at a generic distance from the array in the far field region ($4z_{fraun}$). The three cases can were compared both in the broadside and in the $45^\circ$ off the boresight direction examples. In the broadside case, the inductive and radiative near electric and magnetic fields can be ordered by following the increasing of their intensities as a criterion. It can be noted that the order of these intensities (calling them $E_i$, $H_j$, with {\small$i,j=\overline{-2,2}$}) is the same of that of the feed currents (the relationship is shown or the $E$ field intensities - see \textbf{\cref{eq:current and fields}} - but it works analogously for the $H$ field). In the far field, a totally different phaenomenon is observable (at least in the broadside case and with good approximation in the $45^\circ$ direction too): the $E$ field components are all equal, as those relative to the magnetic field $H$. This can be interpreted as follows: in the near field, the elements of the array still don't behave completely as one radiating object so that their individual radiative effect can be observed, prevailing on the mutual interactions that will make them work as a whole at a further distance (i.e. in the far field). This fact can be explicitly analyzed by looking at the electric and magnetic fields registered at the specific distances: everything is shown in \textbf{\cref{table:EH fields}}. The facts described above can be also observed in \textbf{\cref{fig:EH field}}.
%% \textbf{\cref{fig:EHfields}}
\begin{equation}
	\begin{aligned}
		&\text{If}\quad &C_0\,>\,C_{1}\,>\,C_2 
	\quad	&\text{and} \quad &C_0>C_{-1}>C_{-2}\\ 
		&\text{then} \quad &E_0\,>\,E_{1}\,>\,E_2\	
		\quad		&\text{then} \quad  &E_0>E_{-1}>E_{-2}\\
	\end{aligned}
	\label{eq:current and fields}
\end{equation}


\section*{Methods}
In this conclusive paragraph, a list of the \texttt{MatLab} commands that are not available for all the tools that have been used will be pointed out. Next, the computational costs related to the different parts of the project will be discussed. In the end, a comparison between the array of PIFAs realized in \texttt{Matlab} and the \texttt{CST Studio Suite (Student edition)} will be shown. 

\begin{figure*}[b!]
	\centering
	\begin{minipage}{0.4\linewidth}
		\def\svgwidth{0.9\linewidth}
		\tiny{\input{time_bench.pdf_tex}}
		\caption{Analysis of the computational cost of PIFA vs PCB in the calculation of the radiation pattern (single antenna and array) and of the sparameters}
		\label{fig:pifa pcb cost}
	\end{minipage}\hspace{0.1\linewidth}
	\begin{minipage}{0.35\linewidth}
	\def\svgwidth{0.9\linewidth}
	\tiny{\input{pifa_matlab_vs_cst.pdf_tex}}
	\caption{2D gain patterns in the azimuth cut: comparison between the PIFA created in \texttt{Matlab} (\textcolor{myOrange}{$\blacksquare$}) and that designed in \texttt{CST Studio Suite} (\textcolor{myBlue}{$\blacksquare$}).}
	\label{fig:cst vs matlab}
	\end{minipage}
\end{figure*}
 

The theoretical formulations extracted from \textbf{\cite{Balanis1}} and adopted for this project regarding the pre-optimized PIFA model and the Tchebyshev array factor design have been also implemented in \texttt{Wolfram Mathematica}, which enables the user to write and compute formulas in a very fast and clear fashion (for this purpose the software acts as a \texttt{Computer Algebra System}). 

Explaining what are the limitations of every tool and our previous suggestions about how to combine them (this made it possible to get conclusive results) may help the reader who wants to engage himself into doing some similar studies about array of antennas. Four different \texttt{MatLab} tools belonging to two different toolboxes have been used for this project. By using the \texttt{Antenna Designer} tool, the PIFA structure has been generated and analyzed, while the PCB stack has been created and studied through the \texttt{PCB Antenna Designer} and we acquired the array of PCBs from the \texttt{AAD}. All these tools belong to the \texttt{Antenna Toolbox} (\textbf{\cite{AntennaToolbox}}), while the \texttt{SAA} (by which the study of the array of PIFAs is possible) is part of the \texttt{Phased SAA} (\textbf{\cite{PhasedArraySystemToolbox}}). The differences in terms of the informations than can be directly extracted by using commands from the two main toolboxes used for this projects are shown in \textbf{\cref{table:matlab commands}}. 

We dedicate also a short  paragraph to discuss about the computational costs. In terms of \emph{random access memory} (RAM) occupied by the different elements during simulations, the single PIFA weights 960 MB, while the single PCB 1.2 GB; the array of PIFAs occupies 4 GB while the array of PCBs engages 5.6 GB of memory. The RAM occupation is not enough in order to describe the computational costs, but it represents just a starting point (it gives information about the "stone" that needs to be carried, but not about how long). Thus, the informations about the the time spent by the workstation adopted for the project to complete the calculations of different simulations are collected in \textbf{\cref{table:time for functions}}. The running time for one the radiation pattern simulation (in both single PIFA and PCB antennas and arrays) and the \texttt{sparameters()} function (which calculates a list of parameters which $\Gamma$ belongs to) for both the single PIFA and the PCB is shown in \textbf{\cref{fig:pifa pcb cost}}. 

We realized a PIFA model also in \texttt{CST Studio Suite} and plotted its 2D radiation pattern diagrams. For the seek of a further comparison, the data related to the gain pattern in the azimuth cut have been exported as a \texttt{.txt} file which have been converted into an array in \texttt{Matlab} so that the gain pattern in this cut could be overlapped to that of the PIFA realized with the \texttt{Antenna Designer} (see \textbf{\cref{fig:cst vs matlab}}).
\begin{multicols}{2}
\begin{equation}
	\begin{aligned}
		u_0&=\alpha d_{opt}\,=\,2\pi\frac{d_{opt}}{\lambda}\,\cos(\theta_0)\\
		\alpha_n&=n\,\alpha\,d_{opt}=nu_0\qquad \left(n=\overline{1,5}\right)
		\label{eq:phase coefficients}
	\end{aligned}
\end{equation}

\begin{equation}
	G_{total}=\,\eta_T\,G_0\,G_T
	\label{eq:pattern multiplication}
\end{equation}

\end{multicols}

\begin{table*}[bt!]	\small{
	\begin{center}
	{\fontfamily{ptm}\selectfont\small
		\begin{tabular}{|m{15.5cm}|c|c|}
			\hline
			\cellcolor{deepsaffron}\textbf{Commands} & \cellcolor{flax}\texttt{SAA} & \cellcolor{flax}\texttt{AAD} \\
			\hline
		 \colorbox{backcolour}{\texttt{pattern(\dots)}}
			
			\small{ {(it makes 2D or 3D patterns - i.e. gain, directivity, power -  starting from different different inputs; 
					specifying the object and the frequency are two absolutely necessary inputs)}}
			& \textcolor{ForestGreen}{\cmark} $\:^*$
			
		& \textcolor{ForestGreen}{\cmark} 
			
			{} \\
			\hline
			\colorbox{backcolour}{\texttt{patternAzimuth(\dots)/patternElevation(\dots)}}
			
			\small{ {(they create 2D patterns - i.e. directivity, power, ecc. - in the azimuth and elevation cut planes, respectively. Syntax specs to the privious command)}} & \textcolor{ForestGreen}{\cmark} & \textcolor{Mahogany}{\xmark} \\
			\hline
		\colorbox{backcolour}{\texttt{patternMultiply}}
			
			\small{{(the several patterns coming out of this command - i.e. gain, directivity, power - are computed by means of the pattern multiplication principle, a mathematical approximation of the radiation diagrams which doesn't take into account mutual coupling between the elements of the array)}} & \textcolor{Mahogany}{\xmark} &\textcolor{ForestGreen}{\cmark}  \\
			\hline
		\colorbox{backcolour}{\texttt{arrayFactor(\dots)}}
			
			\small{{(it shows different patterns - i.e. gain, directivity, power - by disregarding completely their influence from the specific element used in the array )}} &\textcolor{Mahogany}{\xmark} & \textcolor{ForestGreen}{\cmark} \\
			\hline
		\colorbox{backcolour}{\texttt{phased.SteeringVector}}
			
			\small{{(it allows running beamsteering analysis by specifying the two spatial angles; it's the input of another command which gives all the weights related to possible phase shifts between the elements of the array)}} & \textcolor{ForestGreen}{\cmark} & \textcolor{Mahogany}{\xmark} \\
			\hline
		\colorbox{backcolour}{\texttt{conformalArray(\dots)}}
			
			\small{{(any element frtom the antenna ora array library can be used to generat an antenna array, except of the PIFA and some other cases)}} & \textcolor{ForestGreen}{\cmark} & \textcolor{Mahogany}{\xmark} \\
			\hline
			\colorbox{backcolour}{\texttt{polarpattern(\dots)}}
			
			\small{{(different patterns from all the tools can be extracted as 2D matrices data objects. This gives the opportunity to overlap and compare patterns coming from different tools, by introducing the matrices as inputs of this command.)}} & \textcolor{ForestGreen}{\cmark} &  \textcolor{ForestGreen}{\cmark} \\
			\hline
	\end{tabular}}
\end{center}
	\footnotesize{$^*$ only 3D}
	\caption{This table is listing some of the commands which have been used for this project. Some of them are partly or fully compatible with both the tools used for the array analysus and others have been implemented by \texttt{Matlab} to work only in one of them. The main issue of the simulation part was the array of PIFAs could be realized with \texttt{SAA} but using that tool didn't allow to study the electromagnetic field. Instead, the \texttt{AAD} permitted the realization of an array of PCBs, which electromagnetic field could be represented and discussed.}
	\label{table:matlab commands}}
\end{table*} 

\begin{table}[bt!]	
	\centering
\small{	\begin{minipage}{0.45\linewidth}
	\begin{center}
		{\fontfamily{ptm}\selectfont
			\begin{tabular}{|m{5.4cm}|m{1.6cm}|}
				\hline
				\rowcolor{deepsaffron}\textbf{Function} & \textbf{Time$^*$} (s)  \\
			
				\hline
				\colorbox{backcolour}{\texttt{refinement\_time(\dots)}}	& $6.649\cdot 10^3$  \\
				\hline
				\colorbox{backcolour}{\texttt{refinement\_time2(\dots)}}	& $3.816\cdot 10^3$  \\
			\hline
				\colorbox{backcolour}{\texttt{refinement\_time3(\dots)}}	& $6.994\cdot 10^3$  \\
			\hline
				\colorbox{backcolour}{\texttt{contour\_plot(\dots)}}	& $7.149\cdot 10^3$  \\
			\hline
				\colorbox{backcolour}{\texttt{impedance\_mathcing(\dots)}}	& $1.752\cdot 10^2$  \\
			\hline

		\end{tabular}}
	\end{center}
	\tiny{$^*$ Intel i7-10850H @2.70 GHz - 32 GB RAM - Dell Precision 3551}
	\caption{The optimization process went through different steps, as described in the previous sections. Here, some of the computational duration required to completely execute some of the simulations (related to one of the workstations which have been used) are listed so the reader may have an idea of the computational costs for this project} 
	\label{table:time for functions}
			\end{minipage}\hspace{0.05\linewidth}
		\begin{minipage}{0.45\linewidth}
			\begin{center}
				{\fontfamily{ptm}\selectfont	\begin{tabular}{|m{1.5cm}|m{1cm}|m{1cm}|m{1.8cm}|m{1.6cm}|}
						\hline
						\rowcolor{deepsaffron}\textbf{$\Gamma_{final}$} & \textbf{$R_{in}$} & $Y_{in}$ & $B_{|\Gamma|<-10\,dB}$ & $B_{|\Gamma|<-20\,dB}$\\
						\hline
						 $-54.94\,dB$&  $49.86\,\Omega$ & $ 0.11\,S$ & \small{[2.075,2.125]} GHz & \small{[2.09,2.11] GHz}\\
						\hline
				\end{tabular}}
				\caption{Final $\Gamma$ and impedance matching values after last optimization choice: the $w_{\operatorname{feed}}$ change. The band restriction is considered in two cases: when $10\%$ of the voltage signal is coming back (band of frequencies observing the condition $|\Gamma|<-20\,dB$) and when about $32\%$ of the voltage signal is returning (band observing $|\Gamma|<-10\,dB$) }
				\label{table:Gamma and Z}
			\end{center}
		\end{minipage}
	}
\end{table} 

\section*{Conclusions}
The different analysis conducted in this paper have fulfilled the project requirements (none of them has been omitted). 
The toolbox which have been used made possible to reach the final results (related to electric and magnetic fields) using the PCB structure as the antenna element of the array since the array of PIFAs isn't compatible for this type of study. Using the array of PCBs introduced an admissible set of errors. The use of the array of PCBs led to a notable increase of the computational costs  and this may represent an obstacle to users that would like to replicate the results but having machines who don't have enough memory resources. 

%\pagebreak

\section*{Data availability}

All the \texttt{Matlab} code is available in the online repository (file 	\colorbox{backcolour}{\texttt{final\_wet\_project.m}}) at the following link: \url{https://github.com/mastroalex/antenna-design}.

There are also available more plot and information about antenna and array properties. There are all the raw data for plot and calculation.

In the appendix there are different patterns (for PCB and PIFA comparison), 3D gain patterns, Smith diagram, and different antenna / array diagrams. There is also a project workflow and some code snippets. 


\printbibliography



%\section*{References}
\pagebreak
\appendix
%\section*{Appendix}
%	\subsection*{Figures and patterns}

	

	\begin{figure*}[b!]
			\centering
	\begin{subfigure}{0.32\linewidth}
	\def\svgwidth{\linewidth}
	\tiny{\input{EHfield_prfaun_broadside.pdf_tex}}
	\caption{}
\end{subfigure}\hspace{0.13\linewidth}
\begin{subfigure}{0.32\linewidth}
	\def\svgwidth{\linewidth}
	\tiny{\input{EHfield_prfaun_45.pdf_tex}}
	\caption{}
\end{subfigure}
\begin{subfigure}{0.32\linewidth}
	\def\svgwidth{\linewidth}
	\tiny{\input{EHfield_pfarfield_broadside.pdf_tex}}
	\caption{}
\end{subfigure}
	\begin{subfigure}[b]{0.13\linewidth}
	\def\svgwidth{\linewidth}
	\tiny{\input{EH_legend.pdf_tex}}
\end{subfigure}	
\begin{subfigure}{0.32\linewidth}
	\def\svgwidth{\linewidth}
	\tiny{\input{EHfield_pfarfield_45.pdf_tex}}
	\caption{}
\end{subfigure}
\caption{EH Fields in radiative near field region for broadside (a) and 45° off boresight direction (b) and in far field region for broadside (c) and 45° off boresight direction (d) }				
		\begin{subfigure}{0.35\linewidth}
			\def\svgwidth{\linewidth}
			\tiny{\input{gamma1_tex.pdf_tex}}
						\caption{}
		\end{subfigure}\hspace{0.1\linewidth}
		\begin{subfigure}{0.35\linewidth}
			\def\svgwidth{\linewidth}
			\tiny{\input{gamma3_tex.pdf_tex}}
			\caption{}
		\end{subfigure}
		\caption{The two best $\Gamma$ plots depending on the specific patch size expressed coupled variations ($L_{\operatorname{patch}},W_{\operatorname{patch}}$) and represented in a frequency range of $[2.0,2.1]\,GHz$}
		\label{fig:Gamma couple LpWp}
		\begin{subfigure}{0.32\linewidth}
			\def\svgwidth{\linewidth}
			\tiny{\input{pcb_structure_tex.pdf_tex}}
		\end{subfigure}\hspace{0.1\linewidth}
		\begin{subfigure}{0.32\linewidth}
			\def\svgwidth{\linewidth}
			\tiny{\input{pcb_structure_top_tex.pdf_tex}}
		\end{subfigure}
		\caption{3D view and top view of the PIFA approximation realized with a PCB stack and cylindrical shorting pins}
		\label{fig:pcb shorting}
	\end{figure*}


\begin{figure*}[b!]
		\begin{subfigure}{\linewidth}
	\def\svgwidth{\linewidth}
	\tiny{\input{array_pcb.pdf_tex}}
\end{subfigure}
\caption{PCB array}
\end{figure*}


\begin{figure*}[b!]
	\begin{subfigure}{0.24\linewidth}
		\def\svgwidth{\linewidth}
		\fontsize{4}{4}\selectfont{\input{pcb_vs_pifa_array_gain_azimuth_broadside.pdf_tex}}
		\caption{}
	\end{subfigure}
	\hfill
	\begin{subfigure}{0.24\linewidth}
		\def\svgwidth{\linewidth}
		\fontsize{4}{4}\selectfont{\input{pcb_vs_pifa_array_gain_elevation_broadside.pdf_tex}}
		\caption{}
	\end{subfigure}
	\hfill
	\begin{subfigure}{0.24\linewidth}
		\def\svgwidth{\linewidth}
		\fontsize{4}{4}\selectfont{\input{pcb_vs_pifa_array_gain_azimuth_45.pdf_tex}}
		\caption{}
	\end{subfigure}
	\hfill
	\begin{subfigure}{0.24\linewidth}
		\def\svgwidth{\linewidth}
		\fontsize{4}{4}\selectfont{\input{pcb_vs_pifa_array_gain_elevation_45.pdf_tex}}
		\caption{}
	\end{subfigure}
	\caption{2D gain patterns (PIFA (\textcolor{myBlue}{$\blacksquare$}) and PCB (\textcolor{myOrange}{$\blacksquare$})) in both the broadside case (azimuth (a) cut and elevation (b) cut) and $45^\circ$ off the boresight direction (azimuth (c) cut and elevation (d) cut). The curve with the dashed line has not been calculated regularly but mirrored, due to the limitation in the maximum elevation angle range which can be asked for in the \texttt{SAA} patterns.}
	\begin{subfigure}{0.24\linewidth}
	\def\svgwidth{\linewidth}
	\fontsize{4}{4}\selectfont{\input{pifa_pcb_null_azymuth_comparison_tex.pdf_tex}}
	\caption{}
\end{subfigure}	\hfill
\begin{subfigure}{0.24\linewidth}
	\def\svgwidth{\linewidth}
	\fontsize{4}{4}\selectfont{\input{pifa_pcb_null_elevation_comparison_tex.pdf_tex}}
	\caption{}	\end{subfigure}	\hfill
\begin{subfigure}{0.24\linewidth}
	\def\svgwidth{\linewidth}
	\fontsize{4}{4}\selectfont{\input{pifa_pcb_array_azimuth_comparison_tex.pdf_tex}}
	\caption{}
\end{subfigure}
\hfill
\begin{subfigure}{0.24\linewidth}
	\def\svgwidth{\linewidth}
	\fontsize{4}{4}\selectfont{\input{pifa_pcb_array_elevation_comparison_tex.pdf_tex}}
	\caption{}	\end{subfigure}

		\caption{
		PIFA (\textcolor{myBlue}{$\blacksquare$}) and PCB (\textcolor{myOrange}{$\blacksquare$}) single antenna directivity patterns (dB) in the Azimuth cut  ($\theta_{el}=0^\circ$, (a)) and in the Elevation cut ($\phi_{az}=0^\circ$, (b)). PIFA and PCB arrays directivity patterns (dB) in the Azimuth cut  ($\theta_{el}=0^\circ$, (c)) and in the Elevation cut ($\phi_{az}=0^\circ$, (d))}
	\label{fig:pcb pifa array comparison}

	\begin{subfigure}{0.28\linewidth}
	\def\svgwidth{\linewidth}
	\tiny{\input{gain_3D_pifa_tex.pdf_tex}}
	\caption{}
\end{subfigure}
\begin{subfigure}{0.32\linewidth}
	\def\svgwidth{\linewidth}
	\tiny{\input{gain_3D_array.pdf_tex}}
	\caption{}
\end{subfigure}	\hfill
\begin{subfigure}{0.38\linewidth}
	\def\svgwidth{\linewidth}
	\tiny{\input{smith_chart.pdf_tex}}
	\caption{}
\end{subfigure}

\caption{Gain pattern for PIFA single antenna (a) and PCB array (b). Smith chart (c)}

\end{figure*}




\clearpage
%\subsection*{Code}
\begin{figure*}[b!]
	\centering
	\begin{tikzpicture}
		\label{fig:flowchart}
		\node (startp) [startstop,xshift=0.45\linewidth] {\textmd{INPUT VARIABLES}
			
				\fontsize{6}{4}\selectfont frequency, matched input impedance, FR4 substrate, patch and ground features, PIFA condition on shorting to reach equivalence between folded structure and PIFA};		
		\node (pro1) [process, below of=startp ,yshift=-1.4cm] {
			\textmd{	THEORY}
			
				\fontsize{6}{4}\selectfont theoretical formulation to evaluate patch parameters – i.e. pre-optimized PIFA features 
		};
		\node (pro2) [process, below of=pro1,yshift=-1cm ] {
			\textmd{SUBSTRATE (thickness selection)}
			
			\fontsize{6}{4}\selectfont 	based on radiative theoretical behaviour and tool instructions
		};
		\node (pro3) [process, below of=pro2,yshift=-1.4cm] {
			\textmd{MATLAB (mesh refinement)}
			
			\fontsize{6}{4}\selectfont 	study of the influence of the mesh density level parameter (maximum edge length) to the reflection coefficient and the resonant frequence. Mesh level selection so that best accuracy can be reached.
		};
		\node (pro4) [process, below of=pro3,yshift=-1.6cm] {\textmd{ MATLAB (parametric study)}
			
			\fontsize{6}{4}\selectfont 	study of the influence of some of the patch parameters (i.e. length, width, feed location) on the reflection coefficient.
		};
		\node (out1p) [io, below of=pro4,yshift=-1.2cm] {\textmd{ OPTIMIZED PIFA}
			
			\fontsize{6}{4}\selectfont 	resonant at the operating frequency input and impedance matching};
		
		\node (A) [above  of=  startp,yshift=0.8cm]  {\textmd{\textcolor{orange_work}{Folded patch antenna design}}};
		\node[fit= (A) (startp) (pro1) (pro2) (pro3) (pro4) (out1p), dashed,draw,inner sep=0.45cm] (Box){};
		
		\draw [arrow] (startp) -- (pro1);
		\draw [arrow] (pro1) -- (pro2);
		\draw [arrow] (pro2) -- (pro3);
		\draw [arrow] (pro3) -- (pro4);
		\draw [arrow] (pro4) -- (out1p);
		
		\node (start) [startstop,left of=startp,xshift=-0.45\linewidth]
		{\textmd{INPUT VARIABLES}
			
			\fontsize{6}{4}\selectfont 	no. of elements, mean to side lobe ratio, operating frequency};
		
		\node (out1) [io, below of=start,yshift=-1 cm] {\textmd{OUTPUT VARIABLES}
			
			\fontsize{6}{4}\selectfont 	optimal inter-spacing between elements to minimize the beamwidth; feed coefficients and tapering efficiency};
		\draw [arrow] (start) -- (out1);
		
		\node (B) [above  of=  start,yshift=0.8cm]  {\textmd{\textcolor{orange_work}{Array factor design}}};
		\node[fit= (B) (out1), dashed,draw,inner sep=0.45cm] (Box1){};
		
		
		
		\node[draw,
		circle,
		minimum size=0.6cm,
		fill=backcolour,below of=out1,yshift=-1.2cm] (sum) {};
		
		\draw (sum.north east) -- (sum.south west)
		(sum.north west) -- (sum.south east);
		
		\draw [arrow] (Box.west) |- (sum.east);
		\draw [arrow] (Box1.south) -- (sum.north);
		
		
		\node (start_T) [decision,below of=sum,yshift=-1.5cm]
		{\textmd{\small TOOL LIMITATIONS}};
		
		\node (pro2a) [process3, below of=start_T,yshift=- 1.6 cm,xshift=-2.8cm] {\textmd{PCB ANTENNA DESIGNER}
			
			\fontsize{6}{4}\selectfont 	PCB stack (patch, substrate, ground, feed, cylindrical shorting pins) approximating the PIFA structure};
		\node (pro2b) [process3, below of=start_T,yshift=- 1.6 cm,xshift=2.4cm] 
		{ \textmd{SENSOR \\ARRAY ANALYZER}
			
			\fontsize{6}{4}\selectfont 	array of PIFAs, broadside and 45° to boresight conditions};
		
		\node (pro2c) [process4, below of=pro2a,yshift=- 4.6 cm,xshift=2.8 cm] 
		{ \textmd{PCB ARRAY ANALYZER}
			
			\fontsize{6}{4}\selectfont 	array of PCBs, Broadside and 45° to boresight conditions, 2D gain patterns, electric and magnetic near fields};
		
		\node (pro2e) [process2, below of=pro2a,yshift=- 1.8cm] 
		{ \textmd{COMPARISON}
			
			\fontsize{6}{4}\selectfont 	in terms of gain/directivity patterns and error analysis};
		
		\node (pro2d) [process2, below of=pro2b,yshift=- 1.6 cm] 
		{ \textmd{COMPARISON}
			
			\fontsize{6}{4}\selectfont 	in terms of directivity patterns and error analysis};
		
		
		\draw [arrow] (start_T.west) -| (pro2a.north);
		\draw [arrow] (start_T.east) -| (pro2b.north);
		\draw [arrow] (pro2a.east) -| (pro2c.north);
		\draw [arrow] (pro2a) -- (pro2e);
		\draw [arrow] (pro2b) -- (pro2d);
		\draw [arrow] (pro2c) -- (pro2d.south);
		
		
		\draw [arrow] (sum.south) -- (start_T);
		
	\end{tikzpicture} 
	\caption{Flowchart}
	\label{fig:flowchart_2}
\end{figure*}
\begin{figure*}
	\centering
	\begin{subfigure}{0.45\linewidth}
		\begin{lstlisting}[language=Matlab,caption=Cycle over \texttt{MaxEdgeLength} parameter for mesh optimization,label=code1]
for i=1:length(v)
	mesh(p,'MaxEdgeLength',v(i));
	s = sparameters(p,freqRange);
	slog=20*log10(abs(s.Parameters));
	ssi=slog(:,:);
	freq(i)=s.Frequencies(ssi==min(ssi));
	smin(i)=min(ssintax);
	disp('Step: ');
	disp(length(v)+1-i);
	close all
end 
	\end{lstlisting}
	\end{subfigure}\hfill
	\begin{subfigure}{0.45\linewidth}
	\begin{lstlisting}[language=Matlab,caption=Manual phase shift of PCB array for beamstering,label=code2]
	u0 = -k0*dopt*cos(pi/4);
	an = zeros(5,1);
	for i=0:4
		an(i+1,1) = i*u0; 
	end
	kfa_ster=kfa;
	kfa_ster.PhaseShift = an*(180/pi); 
	\end{lstlisting}
\end{subfigure}

\end{figure*}

}
\end{document}